<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JavaScript">
    <meta name="theme-color" content="#ffffff">
    <title>Web os</title>

    <link rel="stylesheet" href="./assets/css/index.css">

    <link rel="icon" href="./assets/img/os.png" sizes="32x32">
    <link rel="icon" href="./assets/img/os.png" sizes="192x192">
    <link rel="apple-touch-icon" href="./assets/img/os.png">

    <script src="https://kit.fontawesome.com/fb0e5ed6b3.js" crossorigin="anonymous"></script>    
  </head>
  <body onload="Horloge()">
    <header>
      <nav>
        <div class="nav-container">
          <div class="nav-left">
            <span id="hour"></span>
            <span id="date"></span>
          </div>
          <div class="nav-right">
            <span id="vibration"></span>
            <span id="battery"></span>
            <span id="latency"></span>
            <span id="lock"><i class="fa-solid fa-power-off"></i></span>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <div id="app-container" class="dropzone">
        <!-- Bouton pour ouvrir la fenêtre de paramètres -->
        <button id="open-settings-btn" class="draggable" draggable="true"></button>

        <!-- Bouton pour ouvrir la fenêtre calculatrice -->
        <button id="open-calculator-btn" class="draggable" draggable="true"></button>

        <!-- Bouton pour ouvrir la fenêtre de l'horlogerie -->
        <button id="open-horlogerie-btn" class="draggable" draggable="true"></button>
      </div>

      <!-- Fenêtre de paramètres -->
      <div id="settings-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h1>Paramètres</h1>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <!-- Configurer l'affichage de l'heure -->
            <section class="separator">
              <h3>Affichage de l'heure</h3>
              <label>
                <input type="checkbox" id="show-hour" checked>
                Afficher l'heure
              </label>
              <br>
              <label>
                <input type="checkbox" id="show-minute" checked>
                Afficher les minutes
              </label>
              <br>
              <label>
                <input type="checkbox" id="show-second" checked>
                Afficher les secondes
              </label>
            </section>

            <!-- Configurer la date -->
            <section class="separator">
              <h3>Affichage de la date</h3>
              <label>
                <input type="checkbox" id="show-date" checked>
                Afficher la date
              </label>
              <br>
              <label>
                <input type="checkbox" id="show-year" checked>
                Afficher l'année
              </label>
              <br>
              <label>
                <input type="checkbox" id="show-month" checked>
                Afficher le mois
              </label>
              <br>
              <label>
                <input type="checkbox" id="show-day" checked>
                Afficher le jour
              </label>
            </section>

            <!-- Configurer la vibration -->
            <section class="separator">
              <h3>Vibration</h3>
              <label>
                <input type="checkbox" id="show-vibration" checked>
                Afficher l'état de la vibration
              </label>
              <br>
              <label>
                <input type="checkbox" id="enable-vibration" checked>
                Activer les retours haptiques de vibration
              </label>
            </section>

            <!-- Configurer la batterie -->
            <section class="separator">
              <h3>Batterie</h3>
              <label>
                <input type="checkbox" id="show-battery" checked>
                Afficher l'état de la batterie
              </label>
            </section>

            <!-- Configurer la latence réseau -->
            <section class="separator">
              <h3>Latence réseau</h3>
              <label>
                <input type="checkbox" id="show-latency" checked>
                Afficher la latence réseau
              </label>
              <br>
              <label>
                Nom de domaine du serveur de ping :
                <input type="text" id="ping-server" value="google.com">
              </label>
              <br>
              <label>
                Délai de rafraîchissement en secondes :
                <input type="number" id="latency-refresh-rate" min="1" max="60" step="1" value="5">
              </label>
            </section>

            <!-- Configurer la méthode de verrouillage de l'appareil -->
            <section class="separator">  
              <h3>Méthode de verrouillage de l'appareil</h3>
              <label>
                <input type="radio" id="lock-method-pin" name="lock-method-pin" value="pin" checked> 
                Code PIN
              </label>
              <br>
              <label>
                <input type="radio" id="lock-method-pattern" name="lock-method-pin" value="pattern"> 
                Motif
              </label>
            </section>

            <!-- Configurer le thème -->
            <h3>Thème</h3>
            <label>
              <input type="radio" id="theme-light" name="theme" value="light" checked>
              Light
            </label>
            <br>
            <label>
              <input type="radio" id="theme-dark" name="theme" value="dark">
              Dark
            </label>

            <!-- Bouton pour enregistrer les paramètres -->
            <form>
              <button id="save-settings-button">Enregistrer les paramètres</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Fenêtre calculatrice -->
      <div id="calculator-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h1>Calculatrice</h1>
            <span class="close-calc">&times;</span>
          </div>
          <div class="modal-body">
            <div id="dark">
              <input type="checkbox" id="dark-mode-switch">
              <label for="dark-mode-switch"></label>
            </div>
            <div id="calculator">
                <input type="text" id="display">
                <br>
                <button id="btn-clear" class="other">C</button>
                <button id="btn-pos-neg" class="other">+/-</button>
                <button id="btn-divide" class="other">/</button>
                <button id="btn-multiply" class="other">*</button>
                <br>
                <button id="btn-7" class="number">7</button>
                <button id="btn-8" class="number">8</button>
                <button id="btn-9" class="number">9</button>
                <button id="btn-minus" class="other">-</button>
                <br>
                <button id="btn-4" class="number">4</button>
                <button id="btn-5" class="number">5</button>
                <button id="btn-6" class="number">6</button>
                <button id="btn-plus" class="other">+</button>
                <br>
                <button id="btn-1" class="number">1</button>
                <button id="btn-2" class="number">2</button>
                <button id="btn-3" class="number">3</button>
                <button id="btn-equals" class="other">=</button>
                <br>
                <button id="btn-0" class="number">0</button>
                <button id="btn-dot" class="other">.</button>
                <button id="btn-backspace" class="other"><i class="fa-solid fa-delete-left"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Fenêtre horlogerie -->
      <div id="horlogerie-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h1>Horlogerie</h1>
            <span class="close-horlogerie">&times;</span>
          </div>
          <div class="modal-body">

              <ul>
                  <li><a id="minuteur-btn">Minuteur</a></li>
                  <li><a id="chrono-btn">Chronomètre</a></li>
                  <li><a id="horloge-btn">Horloge</a></li>
              </ul>
            <div id="horlogerie">
              <div id="horloge">
                
                <span id="horloge"></span>
              </div>
              <div id="chrono">
                <h1>Chronomètre</h1>
                  <div id="time"></div>

                  <form name="parametre" action="" method="">
                      <input type="button" name="lance" value="Démarrer" onclick="chrono();debut();" />
                      <input type="button" name="pause" value="Stop" onclick="arret();" disabled="disabled" />
                      <input type="button" name="zero" value="Effacer" onclick="arret();raz();" disabled="disabled" />
                      <input type="button" name="intermediaire" value="Intermediaire" onclick="inter();" disabled="disabled" />
                      <input type="button" name="rappel" value="Rappel" onclick="rappeler();" disabled="disabled" />
                  </form>

                  <div id="presenter">
                      <p>Temps intermediaire :</p>
                      <span id="interm"></span>
                  </div>
              </div>
              <div id="minuteur">
                <h1>Minuteur</h1>
                <input type="number" id="input">
                <input type="button" value="Démarrer" onclick="minuteur()">
                <input type="button" value="Stop" onclick="stop()">
                <div id="timer">00:00</div>
                <audio id="xyz" src="./assets/audio/soundeffect2.mp3"></audio>
              </div>
            </div>
          </div>

      </div>
    </main>

    <script>
      const openSettingsBtn = document.getElementById("open-settings-btn");
      const settingsModal = document.getElementById("settings-modal");
      const closeBtn = document.querySelector(".close");

      openSettingsBtn.addEventListener("click", function() {
        settingsModal.style.display = "block";
      });

      closeBtn.addEventListener("click", function() {
        settingsModal.style.display = "none";
      });

      const openCalculatorBtn = document.getElementById("open-calculator-btn");
      const calculatorModal = document.getElementById("calculator-modal");
      const closeBtnCalc = document.querySelector(".close-calc");

      openCalculatorBtn.addEventListener("click", function() {
        calculatorModal.style.display = "block";
      });

      closeBtnCalc.addEventListener("click", function() {
        calculatorModal.style.display = "none";
      });

      const openHorlogerieBtn = document.getElementById("open-horlogerie-btn");
      const horlogerieModal = document.getElementById("horlogerie-modal");
      const closeBtnHorlogerie = document.querySelector(".close-horlogerie");

      openHorlogerieBtn.addEventListener("click", function() {
        horlogerieModal.style.display = "block";
      });

      closeBtnHorlogerie.addEventListener("click", function() {
        horlogerieModal.style.display = "none";
      });
    </script>

    <script>
      // Récupérer tous les éléments draggable
      const draggableElements = document.querySelectorAll('.draggable');

      // Stocker les coordonnées initiales de chaque élément draggable
      const draggableElementsPositions = {};
      draggableElements.forEach(element => {
        draggableElementsPositions[element.id] = {
          x: 0,
          y: 0
        };
      });

      // Récupérer les coordonnées finales des éléments depuis localStorage
      const droppedElementsPositions = JSON.parse(localStorage.getItem('droppedElementsPositions')) || {};

      // Utiliser les coordonnées finales pour définir la position initiale de chaque élément
      // draggableElements.forEach(element => {
      //   const id = element.id;
      //   const startPosition = droppedElementsPositions[id] || draggableElementsPositions[id];
      //   element.style.transform = `translate(${startPosition.x}px, ${startPosition.y}px)`;
      //   draggableElementsPositions[id] = startPosition;
      // });
      
      // Ajouter les événements de souris pour tous les éléments draggable
      draggableElements.forEach(element => {
        element.addEventListener('mousedown', dragStart);
      });

      // Ajouter les événements de souris pour la dropzone
      const dropzone = document.querySelector('.dropzone');
      dropzone.addEventListener('dragover', dragOver);
      dropzone.addEventListener('drop', drop);

      // Fonction de démarrage du drag
      function dragStart(e) {
        // Stocker les coordonnées initiales de l'élément
        const id = e.target.id;
        draggableElementsPositions[id].x = e.clientX;
        draggableElementsPositions[id].y = e.clientY;
            
        // startX = e.clientX;
        // startY = e.clientY;

        // // Stocker l'ID de l'élément déplacé dans e.dataTransfer
        // e.dataTransfer.setData("text", e.target.id);
                
        // Définir l'effet de drag
        e.dataTransfer.effectAllowed = 'move';
        
        // Ajouter l'événement de drag à l'élément
        e.target.addEventListener('mousemove', dragOver);
        e.target.addEventListener('mouseup', dragEnd);
      }

      // Fonction de fin de drag
      function dragEnd(e) {
        // Retirer l'événement de drag de l'élément
        e.target.removeEventListener('mousemove', dragOver);
        e.target.removeEventListener('mouseup', dragEnd);

        // Stocker les coordonnées finales de l'élément
        const id = e.target.id;
        const draggableElement = document.getElementById(id);
        const computedStyle = getComputedStyle(draggableElement);
        const finalX = parseInt(computedStyle.left);
        const finalY = parseInt(computedStyle.top);
        droppedElementsPositions[id] = {
          x: finalX,
          y: finalY
        };

        // Sauvegarder les coordonnées finales des éléments dans localStorage
        localStorage.setItem('droppedElementsPositions', JSON.stringify(droppedElementsPositions));

        // Définir la position finale de l'élément
        e.target.style.transform = `translate(${finalX}px, ${finalY}px)`;
      }

      // Fonction de survol pendant le drag
      function dragOver(e) {
        e.preventDefault();
        
        // Récupérer l'élément déplacé
        const id = e.target.id;
        const draggableElement = document.getElementById(id);

        // Calculer le décalage par rapport à la position initiale ou finale selon si l'élément a été déposé dans la dropzone
        const elementStartPosition = droppedElementsPositions[id] || draggableElementsPositions[id];
        const offsetX = e.clientX - elementStartPosition.x;
        const offsetY = e.clientY - elementStartPosition.y;

        // Récupérer la position actuelle de l'élément
        const currentX = parseInt(draggableElement.style.left) || 0;
        const currentY = parseInt(draggableElement.style.top) || 0;

        // Calculer la nouvelle position de l'élément
        const newX = currentX + offsetX;
        const newY = currentY + offsetY;

        // Déplacer l'élément à la nouvelle position
        draggableElement.style.transform = `translate(${newX}px, ${newY}px)`;
      }

      function drop(e) {
        e.preventDefault();

        // Récupérer l'élément déplacé
        const id = e.dataTransfer.getData('text');
        const draggableElement = document.getElementById(id);

        // Ajouter l'élément à la dropzone
        dropzone.appendChild(draggableElement);

        // Mettre à jour la position initiale de l'élément déplacé
        const initialX = droppedElementsPositions[id] ? droppedElementsPositions[id].x : draggableElementsPositions[id].x;
        const initialY = droppedElementsPositions[id] ? droppedElementsPositions[id].y : draggableElementsPositions[id].y;
        draggableElement.style.transform = `translate(${initialX}px, ${initialY}px)`;
        // Réinitialiser les coordonnées initiales de l'élément
        draggableElementsPositions[id] = {
          x: initialX,
          y: initialY
        };

        // Stocker les coordonnées finales de l'élément déposé dans la dropzone
        const finalX = initialX + e.clientX - draggableElementsPositions[id].x;
        const finalY = initialY + e.clientY - draggableElementsPositions[id].y;
        droppedElementsPositions[id] = {
          x: finalX,
          y: finalY
        };

        // Définir la position finale de l'élément déposé
        draggableElement.style.transform = `translate(${finalX}px, ${finalY}px)`;
      }
    </script>

    <script src="./assets/js/settings.js" type="module"></script>
    <script src="./assets/js/calculator.js" type="module"></script>
  </body>
</html>